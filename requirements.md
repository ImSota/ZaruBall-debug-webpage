# ZMK Firmware Debug Webpage 要件定義書 (Requirements)

## 1. プロジェクト概要
ユーザーが自作キーボード（ZMKファームウェア）のGitHubリポジトリを指定し、そのリポジトリ内のデータを解析してキーボード配列を可視化・不具合診断を行うWebツール。
従来のフォルダ選択方式から、GitHubリポジトリ直接指定方式へ変更し、より手軽に解析可能にする。

## 2. システムの目的
GitHubリポジトリ上のZMKファームウェアデータを読み込み、物理配列と配線マトリクスを動的に再構築する。
画面上で再現されたキーボード配列を用い、ユーザーが不具合のあるキーを複数選択して診断することで、不具合の原因となっているパーツ（ダイオード、スイッチソケット、マイコンのGPIOピン）を推測・特定する。
これにより、同じような不具合の再発防止とトラブルシューティングの効率化を図る。

## 3. 機能要件

### 3.1 データ入力機能 (GitHub Repository)
- ユーザーは解析したいZMKファームウェアの **GitHubリポジトリURL** または **リポジトリ名** を入力する。
- システムは指定されたリポジトリから必要な設定ファイル（`config` フォルダや `.dtsi`, `.overlay` 等）を取得する。

### 3.2 ファームウェア解析機能 (Parser)
取得したテキストファイル群（主に `config` フォルダ内の `.dtsi`, `.overlay` ファイル）から、以下のルールに基づいて情報を抽出する。

- **ファイル読み込みルール**:
    - `.dtsi` (共通設定) と `.overlay` (固有設定) の両方を読み込む。
    - `.overlay` で `.dtsi` の内容が上書き・追記されることを考慮する。

- **解析対象ノード**:
    1.  **`chosen` ノード**:
        - システム全体のデフォルトハードウェア設定。
        - ここで定義されている `zmk,kscan` と `zmk,physical-layout` を起点に、関連するノード（`kscan` や `physical-layout`）を探す。
        - 例:
            ```dts
            chosen {
                zmk,kscan = &kscan0;
                zmk,physical-layout = &physical_layout0;
            };
            ```
    2.  **`kscan` ノード**:
        - キースイッチのマトリクス設定とマイコンピン割り当てを抽出。
        - `compatible`: `kscan-gpio-matrix` (通常マトリクス) か `kscan-gpio-charlieplex` (Charlieplexing) かを判別。
        - `diode-direction`: ダイオードの向き（Col2Row か Row2Col か）。
        - `row-gpios`, `col-gpios`: 使用されているGPIOピン番号を特定。
    3.  **`default_transform` ノード (Matrix Transform)**:
        - スイッチ（論理上の位置）がどのマイコンピン（物理的な行・列）に接続されているかを定義。
        - `RC(row, col)` マクロを解析し、行・列の組み合わせを特定。
        - `col-offset`, `row-offset`: 分割キーボード等での左右のオフセット値を処理。
    4.  **`physical_layout` ノード**:
        - 各スイッチの物理的な配置情報。
        - `default_transform` のスイッチ順序と合致する。
        - キー属性: `<&key_physical_attrs width height x y rotation rx ry>`
            - `width`, `height`: キーのサイズ (1u = 100等)。
            - `x`, `y`: 左上原点の座標。
            - `rotation`: 回転角度。
            - `rx`, `ry`: 回転中心座標。

### 3.3 キーボード配列の可視化
- 解析された `Physical Layout` データに基づき、Canvas上にキーボードを描画する。
- 左右分割キーボードの場合、読み込んだ `.overlay` の情報（オフセット等）に基づき適切に配置する。

### 3.4 不具合診断機能
- **不具合キーの選択**:
    - ユーザーは画面上の可視化されたキーボードから、**不具合のあるキーを複数選択** できる。
- **診断実行**:
    - 「診断（決定）」ボタンを押下することで解析を開始。
- **原因推測**:
    - 選択されたキーの共通項（行、列、ピン等）を分析。
    - 不具合の原因となるパーツを推測して表示する。
        - **ダイオード**: 特定のキーのみ反応しない場合など。
        - **スイッチソケット**: 接点不良など。
        - **マイコンのGPIOピン**: 特定の行または列が丸ごと反応しない場合など。

## 4. UI/UX デザイン方針
- **入力画面**: GitHubリポジトリの入力フォームを目立つ位置に配置。
- **可視化画面**: キーボード配列を直感的に表示。キーをクリックしてトグル選択できるUI。
- **診断結果**: 推測される不具合パーツと、該当するピン番号や箇所を分かりやすく提示する。
